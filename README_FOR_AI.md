# Документация проекта pgsql_api для ИИ

## Общее описание
Проект pgsql_api представляет собой легковесный JavaScript API для взаимодействия с PostgreSQL через PHP-сервер, используя AJAX. Архитектура основана на хранении параметров подключений в сессиях PHP, выполнении запросов по ID или дефолтному соединению, и возвращении результатов в чистом JSON формате без оберток. Фактически реализует push-down архитектуру, где все ограничения и возможности находятся на уровне PostgreSQL.

## Текущее состояние (после рефакторинга)

### Серверная часть (pgsql.php)
- Управляет параметрами подключений через сессии PHP
- Создает соединения с PostgreSQL только при необходимости и закрывает их после каждого запроса (реализация stateless соединений)
- Поддерживает выполнение SQL-запросов по connection ID или дефолтному соединению
- Поддерживает смену CURRENT_ROLE через отдельный метод
- Возвращает ошибки и результаты в чистом JSON без оберток
- Минималистичный код без валидации, фильтров и абстракций
- Все ограничения на уровне PostgreSQL
- Поддерживает именованные подключения с возможностью генерации уникальных ID
- Автоматически устанавливает первое подключение как дефолтное

#### Поддерживаемые действия:
- `connect`: Создание подключения с параметрами {host, dbname, user, password, port, name}
- `query`: Выполнение SQL-запроса с параметрами {sql, connection}
- `set_role`: Установка роли с параметрами {role, connection}

#### Архитектурные особенности:
- Текущая реализация использует stateless соединения: каждое взаимодействие с базой данных создает новое подключение и закрывает его после выполнения
- Параметры подключения хранятся в сессии PHP, но сами соединения не сохраняются между запросами
- Из-за stateless архитектуры текущая реализация не поддерживает транзакции, охватывающие несколько HTTP-запросов, set role выполняется каждый раз перед началом соединения. поддержка временных таблиц только внутри одного запроса.

### Клиентская часть (pgsql.js)
- Класс PgSqlClient с методами connect, query, setRole для взаимодействия с сервером через AJAX
- Работает с сессиями и connection ID
- Использует fetch API для HTTP-запросов
- Поддерживает как браузерные, так и Node.js окружения
- Возвращает Promise с результатами или ошибками

#### Архитектурные особенности:
- Текущая реализация возвращает только данные или ошибки без дополнительной информации о запросе
- Для расширенной информации (affected_rows, execution_time, и т.д.) потребуется обновление как серверной, так и клиентской части

## Планируемые улучшения (по рекомендациям z.ai)

### Безопасность
- Добавить базовую защиту от CSRF
- Валидация базовых параметров (host, IP и т.д.)

### Расширение возможностей PostgreSQL
- Поддержка всех возможностей PostgreSQL без ограничений
- Поддержка транзакций, подготовленных выражений, курсоров и т.д.
- Без фильтрации - пусть PostgreSQL решает, что можно, а что нельзя

### Метаданные запросов для фронтенда
- Возвращать больше информации от PostgreSQL:
  - affected_rows
  - query_type (SELECT/INSERT/UPDATE/DELETE)
  - execution_time
  - notice_messages

### Расширенная информация о подключении
- Вернуть больше информации от PostgreSQL:
  - server_version
  - server_encoding
  - и другие параметры подключения

### Streaming результатов
- Для больших запросов - потоковая передача
- Использовать pg_fetch_assoc в цикле с immediate выводом

### Поддержка транзакций и постоянных соединений
- Текущая реализация использует stateless соединения (соединение создается и закрывается для каждого запроса)
- Планируется реализация stateful соединений: persistent vs temporary
- Возможность "парковки" сессий на сервере с фиксированными ID
- Сохранение открытых соединений для выполнения сложных операций в сессии (транзакции, временные таблицы)
- Поддержка транзакций с сохранением состояния между запросами
- Поддержка подготовленных выражений (prepared statements)
- Возможность тестирования с множеством клиентов (дедупликация 10,000 клиентов)

## Архитектурные принципы
- Push-down идеология: все ограничения и возможности на уровне PostgreSQL
- Минималистичный код без избыточных абстракций
- Прозрачное взаимодействие с базой данных
- Легковесность и производительность

## Структура файлов
- pgsql.php - серверный обработчик
- pgsql.js - клиентский API
- README_FOR_AI.md - текущий файл документации