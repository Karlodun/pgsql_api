<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGSQL Client Library</title>
    <link rel="stylesheet" href="pgsql.css">
</head>
<body>
    <div class="container">
        <h1>PGSQL Client Library</h1>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="setup">Setup</button>
            <button class="tab-button" data-tab="config">Configuration</button>
            <button class="tab-button" data-tab="how-it-works">How It Works</button>
            <button class="tab-button" data-tab="examples">Examples</button>
            <button class="tab-button" data-tab="tests">Tests</button>
        </div>
        
        <div class="tab-content">
            <!-- Setup Tab -->
            <div id="setup" class="tab-pane active">
                <h2>Setup Instructions</h2>
                <p>To use the PGSQL Client Library:</p>
                <ol>
                    <li>Include the pgsql.js file in your HTML</li>
                    <li>Configure your database profiles in pgsql_config.php</li>
                    <li>Initialize the client with optional endpoint configuration</li>
                </ol>
                
                <h3>Basic Usage</h3>
                <pre><code>const pgsql = new PgSQLClient();
// Or with custom endpoint
const pgsql = new PgSQLClient({ endpoint: '/custom/path/pgsql.php' });</code></pre>
            </div>
            
            <!-- Configuration Tab -->
            <div id="config" class="tab-pane">
                <h2>Configuration</h2>
                <p>The library uses profile-based connections for security. Configure your database profiles in pgsql_config.php:</p>
                
                <pre><code>return [
    'prod_main' => [
        'connection' => [
            'host' => 'localhost',
            'port' => 5432,
            'dbname' => 'production_db'
        ],
        'info' => [
            'name' => 'Production Database',
            'class' => 'Prod',
            'description' => 'Main production database'
        ]
    ],
    'dev_test' => [
        'connection' => [
            'host' => 'localhost',
            'port' => 5432,
            'dbname' => 'development_db'
        ],
        'info' => [
            'name' => 'Development Database',
            'class' => 'Dev',
            'description' => 'Development database for testing'
        ]
    ]
];</code></pre>
            </div>
            
            <!-- How It Works Tab -->
            <div id="how-it-works" class="tab-pane">
                <h2>How It Works</h2>
                <p>The PGSQL Client Library provides a secure way to interact with PostgreSQL databases through a profile-based system:</p>
                
                <ul>
                    <li><strong>Profile-based connections</strong>: No direct host/port access from browser</li>
                    <li><strong>Server-side configuration</strong>: All connection details stored securely on server</li>
                    <li><strong>Session management</strong>: Connections managed through PHP sessions</li>
                    <li><strong>Metadata support</strong>: Query results include execution metadata</li>
                    <li><strong>Transaction support</strong>: Full transaction management capabilities</li>
                </ul>
            </div>
            
            <!-- Examples Tab -->
            <div id="examples" class="tab-pane">
                <h2>Usage Examples</h2>
                
                <h3>Get Available Profiles</h3>
                <pre><code>const profiles = await pgsql.getProfiles();
console.log(profiles);</code></pre>
                
                <h3>Connect to a Profile</h3>
                <pre><code>const connection = await pgsql.connect('prod_main', 'username', 'password');
console.log('Connected with ID:', connection.connection_id);</code></pre>
                
                <h3>Execute Query</h3>
                <pre><code>const result = await pgsql.query('SELECT * FROM users WHERE id = $1', [123]);
console.log(result.data); // Query results
console.log(result.metadata); // Execution metadata</code></pre>
                
                <h3>Transaction Example</h3>
                <pre><code>const transactionResult = await pgsql.transaction(async (connId) => {
    await pgsql.query('INSERT INTO users (name) VALUES ($1)', ['John'], connId);
    await pgsql.query('UPDATE accounts SET balance = balance - 100 WHERE user_id = $1', [1], connId);
    await pgsql.query('UPDATE accounts SET balance = balance + 100 WHERE user_id = $2', [2], connId);
});</code></pre>
            </div>
            
            <!-- Tests Tab -->
            <div id="tests" class="tab-pane">
                <h2>Automated Tests</h2>
                <div id="test-results"></div>
                <button id="run-tests" class="btn-primary">Run All Tests</button>
                
                <h2>Manual Tests</h2>
                <div class="manual-tests">
                    <div class="test-section">
                        <h3>Get Profiles</h3>
                        <button id="test-get-profiles" class="btn-secondary">Get Profiles</button>
                        <div id="profiles-output" class="output"></div>
                    </div>
                    
                    <div class="test-section">
                        <h3>Connect to Database</h3>
                        <select id="profile-select">
                            <option value="">Select a profile</option>
                        </select>
                        <input type="text" id="username" placeholder="Username">
                        <input type="password" id="password" placeholder="Password">
                        <button id="test-connect" class="btn-secondary">Connect</button>
                        <div id="connect-output" class="output"></div>
                    </div>
                    
                    <div class="test-section">
                        <h3>Execute Query</h3>
                        <textarea id="query-input" placeholder="Enter SQL query"></textarea>
                        <input type="text" id="query-params" placeholder="Parameters (JSON array)">
                        <button id="test-query" class="btn-secondary">Execute Query</button>
                        <div id="query-output" class="output"></div>
                    </div>
                    
                    <div class="test-section">
                        <h3>Transaction Test</h3>
                        <button id="test-transaction" class="btn-secondary">Run Transaction</button>
                        <div id="transaction-output" class="output"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="pgsql.js"></script>
    <script src="pgsql_test.js"></script>
    <script>
        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and panes
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                
                // Add active class to clicked button
                button.classList.add('active');
                
                // Show corresponding pane
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Initialize the PGSQL client
        const pgsql = new PgSQLClient();
        
        // Populate profiles dropdown when Get Profiles is clicked
        document.getElementById('test-get-profiles').addEventListener('click', async () => {
            try {
                const profiles = await pgsql.getProfiles();
                const output = document.getElementById('profiles-output');
                output.innerHTML = '<pre>' + JSON.stringify(profiles, null, 2) + '</pre>';
                
                // Populate the profile select dropdown
                const profileSelect = document.getElementById('profile-select');
                profileSelect.innerHTML = '<option value="">Select a profile</option>';
                for (const [id, profile] of Object.entries(profiles)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${profile.info.name} (${profile.info.class})`;
                    profileSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error getting profiles:', error);
                document.getElementById('profiles-output').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        });
        
        // Connect button functionality
        document.getElementById('test-connect').addEventListener('click', async () => {
            const profileId = document.getElementById('profile-select').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!profileId || !username || !password) {
                alert('Please select a profile and enter username and password');
                return;
            }
            
            try {
                const connection = await pgsql.connect(profileId, username, password);
                document.getElementById('connect-output').innerHTML = '<pre>' + JSON.stringify(connection, null, 2) + '</pre>';
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('connect-output').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        });
        
        // Query button functionality
        document.getElementById('test-query').addEventListener('click', async () => {
            const query = document.getElementById('query-input').value;
            const paramsInput = document.getElementById('query-params').value;
            
            if (!query) {
                alert('Please enter a query');
                return;
            }
            
            let params = [];
            if (paramsInput) {
                try {
                    params = JSON.parse(paramsInput);
                } catch (e) {
                    alert('Invalid parameters format. Please enter as JSON array.');
                    return;
                }
            }
            
            try {
                const result = await pgsql.query(query, params);
                document.getElementById('query-output').innerHTML = '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
            } catch (error) {
                console.error('Query error:', error);
                document.getElementById('query-output').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        });
        
        // Transaction test button
        document.getElementById('test-transaction').addEventListener('click', async () => {
            try {
                const result = await pgsql.transaction(async (connId) => {
                    // Simple test transaction
                    await pgsql.query('SELECT 1 as test', [], connId);
                    return 'Transaction completed successfully';
                });
                
                document.getElementById('transaction-output').innerHTML = `<div class="success">${result}</div>`;
            } catch (error) {
                console.error('Transaction error:', error);
                document.getElementById('transaction-output').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>