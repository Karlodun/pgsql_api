<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Testing for pgsql_api</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-case {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-case h3 {
            margin: 0 0 10px;
        }
        .output {
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        button {
            padding: 5px 10px;
            margin: 5px 0;
            cursor: pointer;
            border: 1px solid #0078D7;
            background-color: #0078D7;
            color: white;
            border-radius: 3px;
        }
        button:hover {
            background-color: #005cbf;
        }
    </style>
    <!-- Load main.js as a module -->
    <script type="module" src="main.js"></script>
    <!-- Load form_ui.js explicitly since it's optional -->
    <script src="form_ui.js"></script>
</head>
<body>
    <h1>Interactive Test Cases for pgsql_api</h1>
    <p>
        Each session can keep multiple PostgreSQL connections alive at once. Use the helpers below to
        register more than one server, switch between them, and run queries without resending
        passwords on every request. You can also run a single query against a specific connection
        while keeping your default connection unchanged.
    </p>

    <!-- Test Case: Create a New Connection -->
    <div class="test-case">
        <h3>Create a New Connection</h3>
        <p>
            This test will create a new connection to the PostgreSQL database.
            The connection ID will be <strong>"test_conn"</strong>.
            Change the connection credentials in script bellow this code.
        </p>
        <button onclick="testCreateConnection()">Run Test</button>
        <div id="output-create-connection" class="output"></div>
    </div>

    <!-- Test Case: Create a Second Connection Without Switching -->
    <div class="test-case">
        <h3>Create a Second Connection Without Switching</h3>
        <p>
            This demonstrates logging into another server without replacing the active connection. The
            new ID will be <strong>"reporting_conn"</strong> and will stay idle until switched.
        </p>
        <button onclick="testCreateSecondConnection()">Run Test</button>
        <div id="output-create-connection-2" class="output"></div>
    </div>

    <!-- Test Case: Switch Connection -->
    <div class="test-case">
        <h3>Switch Connection</h3>
        <p>
            This test will switch to the previously created connection <strong>"test_conn"</strong>.
        </p>
        <button onclick="testSwitchConnection()">Run Test</button>
        <div id="output-switch-connection" class="output"></div>
    </div>

    <!-- Test Case: Run a Query on a Specific Connection Without Switching -->
    <div class="test-case">
        <h3>Run Query on a Specific Connection</h3>
        <p>
            This test runs a query on <strong>"reporting_conn"</strong> while keeping whatever default
            connection was already active. No switch is needed for one-off routing.
        </p>
        <button onclick="testExecuteSQLReporting()">Run Test</button>
        <div id="output-execute-sql-reporting" class="output"></div>
    </div>

    <!-- Test Case: Execute SQL -->
    <div class="test-case">
        <h3>Execute SQL Query</h3>
        <p>
            This test will execute the query <strong>SELECT now();</strong> using the active connection.
            The result should be the current timestamp.
        </p>
        <button onclick="testExecuteSQL()">Run Test</button>
        <div id="output-execute-sql" class="output"></div>
    </div>

    <script>
        /**
         * Test: Create a new connection.
         */
        async function testCreateConnection() {
            const output = document.getElementById('output-create-connection');
            const credentials = {
                id: 'test_conn',
                host: 'localhost',
                user: 'test_user',
                password: 'test_password',
                database: 'test_db',
            };

            try {
                await pgsql_new_conn(credentials);
                output.textContent = 'Connection "test_conn" created. Session cookie stored.';
            } catch (error) {
                output.textContent = `Failed to create connection: ${error}`;
            }
        }

        async function testCreateSecondConnection() {
            const output = document.getElementById('output-create-connection-2');
            const credentials = {
                id: 'reporting_conn',
                host: 'reporting-host',
                user: 'report_user',
                password: 'secret',
                database: 'reporting_db',
            };

            try {
                await pgsql_new_conn(credentials, { setActive: false });
                output.textContent = 'Connection "reporting_conn" registered without switching active session.';
            } catch (error) {
                output.textContent = `Failed to create reporting connection: ${error}`;
            }
        }

        /**
         * Test: Switch to an existing connection.
         */
        function testSwitchConnection() {
            pgsql_switch('test_conn');
            document.getElementById('output-switch-connection').textContent =
                'Switched to connection "test_conn". Check console for confirmation.';
        }

        /**
         * Test: Execute a query against a specific connection without switching defaults.
         */
        async function testExecuteSQLReporting() {
            const output = document.getElementById('output-execute-sql-reporting');
            const query = 'SELECT now();';

            try {
                await pg_sql(query, {
                    connectionId: 'reporting_conn',
                    onSuccess: (rows) => {
                        output.textContent = `Reporting query (no switch) returned: ${JSON.stringify(rows)}`;
                    },
                });
            } catch (error) {
                output.textContent = `Reporting query failed: ${error}`;
            }
        }

        /**
         * Test: Execute a simple SQL query.
         */
        async function testExecuteSQL() {
            const output = document.getElementById('output-execute-sql');
            const query = 'SELECT now();';

            try {
                await pg_sql(query, (rows) => {
                    output.textContent = `Executed query: ${query}. Rows: ${JSON.stringify(rows)}`;
                });
            } catch (error) {
                output.textContent = `Query failed: ${error}`;
            }
        }
    </script>
</body>
</html>
